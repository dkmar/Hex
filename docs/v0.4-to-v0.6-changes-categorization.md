# Hex v0.4.0 ‚Üí v0.6.2 Change Categorization

This document categorizes the conceptual and concrete changes across the 0.4.x ‚Üí 0.6.x release cycle (0.4.0 through 0.6.2).

---

## 1. üéØ Major Feature Additions

### LLM Transformation System (v0.6.0)
**Concept:** Transform transcribed text using LLM providers before pasting.

**Concrete Changes:**
- Added transformation modes (formerly "stacks") with voice prefix detection
- MCP (Model Context Protocol) tool integration, configurable per mode
- Auto-send keyboard command for transformation workflows (#119)
- Provider auto-detection for Claude and Ollama binaries
- Voice prefix matching with punctuation stripping
- Escape key interrupts LLM processing (v0.6.1)
- Currently gated behind developer flag (v0.6.0)

**Files/Components:**
- Text transformation infrastructure
- Provider configuration system (`providerID` strict matching)
- MCP tool group display in modes

### Multi-Variant Parakeet Support (v0.5.0)
**Concept:** Choose between English-only (v2) or multilingual (v3) Parakeet models.

**Concrete Changes:**
- Multiple Parakeet model variant support
- Variant-specific recommendation badges in model picker
- Improved Parakeet recommendation logic and settings UX
- Simplified model picker prioritizing English Parakeet
- Removed language picker for Parakeet (multilingual by default)

### Paste Last Transcript Hotkey (v0.5.0)
**Concept:** Global hotkey to re-paste the most recent transcription.

**Concrete Changes:**
- Polished UI with improved layout and clearer instructions
- Simplified modifier display in hotkey configuration

---

## 2. üîß macOS Sequoia (15.x) Compatibility

### Critical Hotkey Fixes (#122, #124)
**Concept:** Restore keyboard event monitoring on macOS Sequoia after permission model changes broke CGEventTap.

**Timeline of Fixes:**
- **v0.5.4**: Initial Sequoia fix with Input Monitoring permission handling
- **v0.5.5**: Request Input Monitoring permission explicitly
- **v0.5.6**: Restore hotkeys when permission missing
- **v0.5.8**: Remove Input Monitoring guard to allow tap creation (triggers native prompt)
- **v0.5.9‚Äìv0.5.11**: Comprehensive permissions logging and diagnostics
- **v0.5.12**: Enforce Input Monitoring for reliability
- **v0.6.2**: Final fix removing deadlock-causing guard

**Concrete Changes:**
- CGEventTap creation now triggers system permission prompt naturally
- Trust watchdog and automatic recovery from tap-disabled events
- Voice command escape hatch: "force quit Hex now"
- Advanced ‚Üí Export Logs for local diagnostics
- Comprehensive permission state logging

**Files/Components:**
- `KeyEventMonitorClient` with reliability improvements
- `HotKeyProcessor` threshold/semantics documentation
- Permission diagnostics via swift-log

---

## 3. ‚ö° Performance Optimizations

### Recording Latency Elimination
**Concept:** Remove ~500‚Äì700ms startup delay for successive recordings.

**Concrete Changes (v0.5.0‚Äìv0.5.12):**
- Keep `AVAudioRecorder` primed between sessions instead of recreating
- Recorder warm-up after each recording completes for instant subsequent startup
- Recording chime latency fixed by switching to `AVAudioEngine` with pre-loaded buffers
- Media pausing moved off main actor

**Impact:**
- Recording starts immediately (no perceptible delay)
- Start sounds play without lag

### Parakeet Short-Clip Padding (v0.5.7)
**Concept:** Prevent FluidAudio rejection of sub-1.5s recordings.

**Concrete Changes:**
- Pad audio clips shorter than 1.5s with silence
- Technical plan documented in repository

---

## 4. üèóÔ∏è Architecture & Infrastructure

### Logging Modernization (v0.5.0‚Äìv0.5.11)
**Concept:** Replace ad-hoc logging with structured, privacy-aware system.

**Concrete Changes:**
- Migrated to `os.Logger` with privacy annotations
- Introduced `HexLog` helper with predefined categories
- Swift-log integration for exportable diagnostics
- Comprehensive permissions logging

**Files:**
- `HexCore/Sources/HexCore/Logging.swift`
- Category-based logging (`.transcription`, `.recording`, `.settings`)

### Settings Architecture (v0.4.0)
**Concept:** Centralize settings in HexCore for testability and single source of truth.

**Concrete Changes:**
- Migrated `HexSettings` + `RecordingAudioBehavior` into HexCore
- Fixture-based migration tests for backward compatibility
- Pasteboard reliability fix: wait for `NSPasteboard.changeCount` before pasting (#69, #42)

### Client Architecture Expansion
**Concrete Changes:**
- `PermissionClient` architecture introduced
- `SleepManagementClient` added
- `PasteboardClient` integrated into `HistoryFeature`
- `MediaRemote` API for reliable media control (replaced keyboard simulation)

### Release Automation (v0.4.0+)
**Concept:** Adopt Changesets for SemVer and automated changelog management.

**Concrete Changes:**
- Changeset workflow with release.ts validation
- Non-interactive changeset tool for AI agents (`changeset:add-ai`)
- Changelog synced to `Hex/Resources/changelog.md` and GitHub releases
- Sparkle appcast generation with delta updates
- Release tooling prevents duplicate `CFBundleVersion` issues

---

## 5. üé® UX & UI Polish

### Model Management UX (v0.5.0‚Äìv0.6.2)
**Concrete Changes:**
- Simplified, opinionated model picker (no dropdowns)
- Compact list with radio selection, accuracy/speed dots, size display
- Context menu: Show in Finder / Delete
- Missing-model callout with focus-settings action (v0.6.2)
- Download progress/cancel controls in Settings

### Sound Effects (v0.5.0)
**Concrete Changes:**
- Volume slider (adjustable from 20% baseline to 100% legacy loudness)
- Changed default recording audio behavior to `doNothing`

### Menu Bar & History (v0.5.0)
**Concrete Changes:**
- Fixed rendering issue (items no longer appear as single embedded view)
- Corrected history item ordering

### Window Management (Ongoing)
**Concrete Changes:**
- Transcription overlay tracks active window for context-aware placement
- `InvisibleWindow` for indicator overlay
- Fixed Hex appearing in Mission Control and Cmd+Tab

---

## 6. üêõ Bug Fixes

### Clipboard Reliability (v0.5.6)
**Issue:** Panel apps (Alfred, Raycast, Warp) received stale clipboard contents.

**Fix:** Increased paste delay from 100ms ‚Üí 500ms for apps with async clipboard reads.

### Microphone Access Leak (v0.5.0)
**Issue:** Mic retained when recording canceled with ESC (#117).

**Fix:** Proper cleanup on cancellation.

### Hotkey Regression Fixes (v0.5.0)
**Issues:**
- Printable-key hotkeys (e.g., `‚åò+'`) couldn't trigger short recordings (#113)
- Fn and modifier-only hotkeys: wrong side detection, phantom arrow events, firing with extra keys (#89, #81, #87)

**Fixes:**
- Printable keys now support short recordings
- Per-modifier side selection
- Ignore phantom events
- Improved threshold logic (0.3s for modifier-only vs user's `minimumKeyTime` for regular keys)

### Parakeet Voice Prefix (v0.6.0)
**Issue:** Prefix matching failed with trailing punctuation.

**Fix:** Strip `.,;:!?` when matching transformation prefixes.

---

## 7. üõ†Ô∏è Developer Experience

### Hot Reload (v0.4.0)
**Concrete Change:** Integrated InjectionNext for SwiftUI hot reload during development.

### Documentation (v0.5.13+)
**Concrete Changes:**
- Comprehensive `HotKeyProcessor` documentation
- Magic numbers extracted to `HexCoreConstants`
- `CLAUDE.md` guidance for AI agents
- Technical plans (e.g., Parakeet padding strategy)
- Hotkey semantics documented in `docs/hotkey-semantics.md`

### Testing
**Concrete Changes:**
- Settings migration tests with fixtures
- Unit tests runnable via `cd HexCore && swift test`

---

## 8. üì¶ Dependency Updates

### Key Dependency Changes
- **WhisperKit**: Tracking main branch
- **FluidAudio (Parakeet)**: Added with XDG_CACHE_HOME sandboxing
- **Sauce**: Keyboard event monitoring
- **Sparkle**: Auto-updates (feed: `https://hex-updates.s3.amazonaws.com/appcast.xml`)
- **Swift Composable Architecture**: State management (TCA)
- **Inject**: Hot reload

### Tooling
- Bun for release automation
- Changesets for SemVer workflow

---

## 9. üîí Security & Permissions

### Permission Architecture (v0.5.0+)
**Concrete Changes:**
- `PermissionClient` abstraction
- Redesigned permissions UI to compact cards
- Input Monitoring enforcement (Sequoia compatibility)
- Cached installed media players on launch

### Entitlements
**Sandbox Configuration:**
- `com.apple.security.app-sandbox = true`
- `com.apple.security.network.client = true` (model downloads)
- `com.apple.security.files.user-selected.read-write = true` (import)
- `com.apple.security.automation.apple-events = true` (media control)

---

## 10. üìä Version Release Summary

| Version | Key Theme | Major Changes |
|---------|-----------|---------------|
| **0.4.0** | Foundation | Parakeet v3, changesets, settings migration, hotkey improvements |
| **0.5.0‚Äì0.5.7** | Performance & Stability | Multi-variant Parakeet, recorder optimization, media control, Sequoia initial fixes |
| **0.5.8‚Äì0.5.13** | Sequoia Hardening | Permission logging, diagnostics export, Input Monitoring enforcement, hotkey watchdog |
| **0.6.0** | LLM Integration | Transformation modes, MCP tools, auto-send, provider detection |
| **0.6.1** | Polish | Interruptible LLM processing |
| **0.6.2** | Final Fixes | Sequoia deadlock resolution, missing-model UX, strict provider matching |

---

## Removed / Deprecated

1. **Preferred Provider Concept** (v0.6.2): Transformations now strictly use configured `providerID`; no fallback.
2. **Double-Tap Recommendation Text** (v0.5.0): Removed from UI.
3. **Unused Localizations** (v0.5.0): 'Recommended' string removed.
4. **SwiftLint** (v0.4.0): Removed from CI workflow.
5. **Language Picker for Parakeet** (v0.4.0): Hidden (multilingual by default).

---

## Cross-Cutting Patterns

### Issue Resolution Timeline
- **#122, #124 (Sequoia Hotkeys)**: Addressed across 9 releases (v0.5.4‚Äìv0.6.2)
- **#69, #42 (Clipboard)**: Fixed in v0.4.0 and v0.5.6
- **#89, #81, #87 (Fn/Modifier Hotkeys)**: Fixed in v0.5.0
- **#113 (Recording Performance)**: Fixed in v0.4.0‚Äìv0.5.0
- **#117 (Mic Leak)**: Fixed in v0.5.0
- **#119 (Auto-Send)**: Implemented in v0.6.0

### Code Quality Improvements
- Structured logging with privacy
- TCA client architecture expansion
- Fixture-based testing for migrations
- Extracted magic numbers to constants
- Comprehensive inline documentation

---

## Impact Analysis

### User-Facing Impact
**High Impact:**
- Sequoia compatibility restoration
- Recording latency elimination
- LLM transformation capabilities
- Multi-variant model support

**Medium Impact:**
- Clipboard reliability improvements
- Sound effects volume control
- Missing-model UX guidance

**Low Impact:**
- Menu bar rendering fix
- Paste-last-transcript hotkey

### Developer Impact
- Hot reload workflow
- Automated changelog via changesets
- Comprehensive logging for debugging
- AI-friendly tooling (changeset:add-ai)

### Technical Debt Reduction
- Settings centralized in HexCore
- Magic numbers eliminated
- Client architecture standardized
- Permission handling unified
